备忘录
日期: 2025年6月15日
主题: SIP学习摘要 - 重点：SIMPLE框架

此备忘录旨在总结回顾关于SIP协议的学习要点，特别是其强大的扩展框架SIMPLE，它将SIP的应用从语音通话扩展到了现代即时通讯领域。

1. SIMPLE框架核心概述
全称: SIP for Instant Messaging and Presence Leveraging Extensions。
本质: 它不是一个新协议，而是利用SIP现有架构（如代理服务器、注册服务器）的一套扩展和规范。
两大支柱:
状态呈现 (Presence): 让用户能发布并订阅他人的实时状态（如在线、忙碌、离开）。
即时消息 (Instant Messaging): 实现类似短信和聊天的功能。
2. 核心功能一：状态呈现 (Presence) - “你的好友在线吗？”
实现模型: 基于经典的“发布/订阅 (Publish/Subscribe)”模型。
关键SIP方法:
PUBLISH: 用户客户端使用此方法向服务器“发布”自己的当前状态。
SUBSCRIBE: 用户客户端使用此方法向服务器“订阅”好友的状态更新。
NOTIFY: 服务器在收到订阅后，以及每当好友状态变化时，使用此方法主动“通知”订阅者。
工作方式: 可理解为一个动态的“好友状态公告板”，服务器是公告板，用户既是信息发布者也是订阅者。
3. 核心功能二：即时消息 (IM) 与高级功能
3.1. 发送文本消息

实现方法: 使用 MESSAGE 方法，而非INVITE。
工作模式: “寻呼模式”（Sessionless），即发即到，是一次性的交互，无需BYE来结束。
基本流程: A发送MESSAGE -> B收到后回复200 OK（表示已送达），交互完成。
3.2. 实现“已读回执” (关键点)

基础: 仅靠200 OK无法实现“已读”，它只代表“已送达”到设备。
实现标准: 需遵循 RFC 5438 (IMDN) 规范，一个需要双方客户端都支持的扩展功能。
实现流程:
请求: A在发送MESSAGE时，需额外加入IM-Notification头字段，明确要求“显示后通知我”。
通知: 当B的用户真正阅读消息后，B的客户端会构造一个全新的MESSAGE请求发送给A。
回执内容: 这个新MESSAGE的内容是一个特定格式的XML文件，其中包含<display/>标签，这才是“已读”的真正标志。
3.3. 发送短语音/文件 (关键点)

核心原则: 信令与媒体分离 (Separation of Signaling and Media)。
错误方式: 不应将音频或文件等“重”数据直接放入MESSAGE的消息体中，这会因大小限制和效率低下而导致失败。
标准方式:
客户端先将语音/文件通过 HTTP/S协议 上传至专用的媒体服务器 (Media Server)。
媒体服务器返回一个该文件的专属URL链接。
客户端通过SIP的MESSAGE方法，将这个URL作为文本发送给对方。
接收方客户端再通过HTTP/S从该URL下载或播放文件。
类比: 这就像发送“云盘分享链接”，而不是尝试把整个文件塞进短信里。
总结: SIMPLE框架通过巧妙的扩展，将SIP从一个呼叫控制协议转变为一个全功能的统一通信（UC）信令基石。其设计的精髓在于利用SIP作为灵活的信令框架，同时通过各种扩展（如IMDN）和与其他协议（如HTTP）的结合，实现了状态、即时消息、文件传输等丰富功能。